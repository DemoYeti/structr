<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Flow</title>
    <script type="module" src="../../js/persistence/Persistence.js"></script>
    <script type="module" src="../../js/editor/entities/FlowContainer.js"></script>
    <link rel="stylesheet" type="text/css" href="../../css/FlowEditor.css">

    <script src="https://cdn.jsdelivr.net/npm/alight@0.14.0/alight.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/d3@4.10.2/build/d3.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/d3-node-editor@0.6.6/build/d3-node-editor.js"></script>
    <link href="https://cdn.jsdelivr.net/npm/d3-node-editor@0.6.6/build/d3-node-editor.css" rel="stylesheet">
    <link href="../../css/FlowEditor.css" rel="stylesheet">
</head>
<body>

    <script type="module">
        import { Persistence } from "../../js/persistence/Persistence.js";
        import { FlowContainer } from "../../js/editor/entities/FlowContainer.js";
        import {FlowEditor} from "../../js/editor/FlowEditor.js";
        import {FlowConnectionTypes} from "../../js/editor/FlowConnectionTypes.js";


        let persistence = new Persistence();
        let urlParams = new URLSearchParams(window.location.search);

        var id = urlParams.get("id");

        persistence.getNodesById(id, new FlowContainer()).then( r => {
            document.title = "Flow - " + r[0].name;

            const markup = `
                    <div><p>Hier entsteht die Editor-Seite f√ºr den Flow <b>${r[0].name}</b></p></div>
                    <div id="nodeEditor" class="node-editor"></div>
                `;


            document.body.innerHTML = document.body.innerHTML.concat(markup);

            let rootElement = document.querySelector("#nodeEditor");
            let editor = new FlowEditor(rootElement);

            r[0].flowNodes.forEach(node => {
                persistence.getNodesById(node.id).then( n => editor.renderNode(n[0]));
            });

            for(let [name,con] of Object.entries(FlowConnectionTypes.getInst().getAllConnectionTypes())) {

                persistence.getNodesByClass(con).then(relNodes => {
                    relNodes.forEach(rel => {
                       if (r[0].flowNodes.filter(el => el.id === rel.sourceId).length > 0 && r[0].flowNodes.filter(el => el.id === rel.targetId).length > 0) {
                            editor.connectNodes(rel);
                       }
                    });
                });

            }


        });


    </script>
</body>
</html>