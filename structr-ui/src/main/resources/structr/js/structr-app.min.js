var structrRestUrl="/structr/rest/",buttonSelector="[data-structr-action]",altKey=!1,ctrlKey=!1,shiftKey=!1,eKey=!1;
$(function(){var a=new StructrApp(structrRestUrl);a.activateButtons(buttonSelector);$(document).trigger("structr-ready");a.hideNonEdit();$(window).on("keydown",function(b){b=b.which;16===b&&(shiftKey=!0);17===b&&(altKey=!0);18===b&&(ctrlKey=!0);69===b&&(eKey=!0)});$(window).on("keyup",function(b){b=b.which;16===b&&(shiftKey=!1);17===b&&(altKey=!1);18===b&&(ctrlKey=!1);69===b&&(eKey=!1)})});
function StructrApp(a){a&&(structrRestUrl=a);var b=this,g={},f={};this.edit=!1;this.data={};this.btnLabel=void 0;this.activateButtons=function(c){$(c).on("click",function(h){h.preventDefault();h.stopPropagation();var c=$(this);disableButton(c);b.btnLabel=b.btnLabel||c.text();var a=c.attr("data-structr-action").split(":");h=a[0];var l=a[1],a="true"===c.attr("data-structr-reload"),m=c.attr("data-structr-attributes"),m=(m?m.split(","):[]).map(function(c){return c.trim()}),k=c.attr("data-structr-id"),
p=$('[data-structr-id="'+k+'"]');"create"===h?($.each(m,function(c,h){b.data[k]||(b.data[k]={});var a=$('[data-structr-name="'+h+'"]').val();b.data[k][h]=a?a.parseIfJSON():a}),b.create(l,b.data[k],a,function(){enableButton(c)},function(){enableButton(c)})):"edit"===h?b.editAction(c,k,m,a,function(){enableButton(c)},function(){enableButton(c)}):"cancel-edit"===h?b.cancelEditAction(c,k,m,a):"delete"===h?(h=b.field($('[data-structr-attr="name"]',p)),b.del(k,"true"===c.attr("data-structr-confirm"),a,
h?h.val:void 0)):b.customAction(k,l,h,b.data[k],a,function(){enableButton(c)},function(){enableButton(c)})})};this.editAction=function(c,h,a,d){var l=$('[data-structr-id="'+h+'"]');b.hideEdit(l);$.each(a,function(c,a){var e=$('[data-structr-attr="'+a+'"]',l);if(e.length){var d=b.field(e);d.id=h;b.data[h]||(b.data[h]={});b.data[h][a]=d.val;var n="a"===e[0].tagName.toLowerCase()?e:e.parent("a");if(n.length){var g=n.attr("href");n.attr("href","").css({textDecoration:"none"}).on("click",function(){return!1})}var f=
b.input(e);if(!f||!f.is("select")){c="Boolean"===d.type?checkbox(d.id,d.type,d.key,d.val):d.val&&-1!==d.val.indexOf("\n")?textarea(d.id,d.key,d.val):inputField(d.id,d.type,d.key,d.val);e.html(c);e=l.find('[data-structr-attr="'+d.key+'"]');f=b.input(e);f.css({fontFamily:"sans-serif"});resizeInput(f);n.length&&f.attr("data-structr-href",g);if("Boolean"!==d.type)f.on("keyup",function(c){b.checkInput(c,b.field(f),$(this))});if("Date"===d.type)f.on("mouseup",function(c){c.preventDefault();c=$(this);c.datetimepicker({separator:"T",
dateFormat:"yy-mm-dd",timeFormat:"HH:mm:ssz"});c.datetimepicker("show");c.off("mouseup")})}}});$('<button data-structr-action="save" data-structr-id="'+h+'">Save</button>').insertBefore(c);$('button[data-structr-action="save"][data-structr-id="'+h+'"]',l).on("click",function(){b.saveAction(c,h,a,d)});c.text("Cancel").attr("data-structr-action","cancel-edit");enableButton(c)};this.saveAction=function(c,h,a,d){var l=$('[data-structr-id="'+h+'"]');$.each(a,function(c,a){var d=b.input($('[data-structr-attr="'+
a+'"]',l)),d=b.field(d);if(a.contains(".")){delete b.data[h][a];var e=a.split("."),f=e[0],e=e[1];b.data[h][f]={};b.data[h][f][e]=d.val}else b.data[h][a]=d&&"Boolean"===d.type?!0===d.val?!0:!1:d&&d.val&&d.val.length?d.val:null});b.request("PUT",structrRestUrl+h,b.data[h],!1,"Successfully updated "+h,"Could not update "+h,function(){b.cancelEditAction(c,h,a,d)})};this.cancelEditAction=function(c,a,e,d){if(d)window.location.reload();else{var l=$('[data-structr-id="'+a+'"]');$.each(e,function(c,d){var e=
b.input($('[data-structr-attr="'+d+'"]',l));if(!e||!e.is("select")){var f=e.attr("data-structr-href"),g=e.parent("a");f&&g.length&&g.attr("href",f);e.replaceWith(b.data[a][d])}});$('button[data-structr-id="'+a+'"][data-structr-action="save"]').remove();c.text(b.btnLabel).attr("data-structr-action","edit");enableButton(c);b.hideNonEdit(l)}};this.input=function(c){c=$(c[0]);var a;if(c.is("input")||c.is("textarea")||c.is("select"))return c;a=c.children("textarea");if(a.length)return a;a=c.children("input");
if(a.length)return a;a=c.children("select");return a.length?a:null};this.field=function(c){if(c&&c.length){var a=c.attr("data-structr-type")||"String",e=c.attr("data-structr-id"),d=c.attr("data-structr-attr"),l=c.attr("data-structr-raw-value");if("Boolean"===a)c=c.is("input")?c.is(":checked"):"true"===c.text();else{var f=b.input(c);c=f?f.is("select")?$(":selected",f).attr("value"):l||f.val()&&f.val().replace(/<br>/gi,"\n"):l||c.html().replace(/<br>/gi,"\n")}return{id:e,type:a,key:d,val:c,rawVal:l}}};
this.getRelatedType=function(c,a,e){b.request("GET",structrRestUrl+"_schema",null,!1,null,null,function(c){})};this.create=function(c,a,e,d,f){b.request("POST",structrRestUrl+c.toUnderscore(),a,e,"Successfully created new "+c,"Could not create "+c,d,f)};this.customAction=function(c,a,e,d,f,m,k){b.request("POST",structrRestUrl+a.toUnderscore()+"/"+c+"/"+e,d,f,"Successfully execute custom action "+e,"Could not execute custom action "+a,m,k)};this.request=function(a,h,e,d,f,m,k,g){e=JSON.stringify(e);
$.ajax({type:a,url:h,data:e,contentType:"application/json; charset=utf-8",statusCode:{200:function(a){b.dialog("success",f);d?window.setTimeout(function(){window.location.reload()},200):k&&k(a)},201:function(a){b.dialog("success",f);d?window.setTimeout(function(){window.location.reload()},200):k&&k()},400:function(a,c,d){b.dialog("error",m+": "+a.responseText);console.log(a,c,d);g&&g()},401:function(a,c,d){b.dialog("error",m+": "+a.responseText);console.log(a,c,d);g&&g()},403:function(a,c,d){b.dialog("error",
m+": "+a.responseText);console.log(a,c,d);g&&g()},404:function(a,c,d){b.dialog("error",m+": "+a.responseText);console.log(a,c,d);g&&g(a)},422:function(a,c,d){b.dialog("error",m+": "+a.responseText);console.log(a,c,d);g&&g()},500:function(a,c,d){b.dialog("error",m+": "+a.responseText);console.log(a,c,d);g&&g()}}})};this.dialog=function(a,b){$('[data-structr-dialog="'+a+'"]').addClass(a).html(b).show().delay(2E3).fadeOut(200)};this.add=function(a,b,e,d){var f=JSON.parse('{"'+d+'":[{"id":"'+a+'"}]}');
$.ajax({url:structrRestUrl+e.toUnderscore()+"/"+b+"/ui",method:"GET",contentType:"application/json",statusCode:{200:function(a){void 0===a.result[d]?alert("Could not read related property\n\n    "+e+"."+d+"\n\nMake sure it is contained in the\nentity's ui view and readable via REST."):(a.result[d].length&&$.each(a.result[d],function(a,c){f[d].push({id:c.id})}),$.ajax({url:structrRestUrl+e.toUnderscore()+"/"+b,method:"PUT",contentType:"application/json",data:JSON.stringify(f),statusCode:{200:function(){window.location.reload()},
400:function(a){console.log(a)},422:function(a){console.log(a)}}}))}}})};this.remove=function(a,b,e,d){var f=JSON.parse('{"'+d+'":[]}');$.ajax({url:structrRestUrl+b+"/ui",method:"GET",contentType:"application/json",statusCode:{200:function(g){void 0===g.result[d]?alert("Could not read related property\n\n    "+e+"."+d+"\n\nMake sure it is contained in the\nentity's ui view and readable via REST."):(g.result[d].length&&$.each(g.result[d],function(b,e){e.id!==a&&f[d].push({id:e.id})}),$.ajax({url:structrRestUrl+
b,method:"PUT",contentType:"application/json",data:JSON.stringify(f),statusCode:{200:function(){window.location.reload()},400:function(a){console.log(a)},422:function(a){console.log(a)}}}))}}})};this.del=function(a,b,e,d){var f=!0;b&&(f=confirm("Are you sure to delete "+(d?d:a)+"?"));b&&!f||$.ajax({url:structrRestUrl+a,method:"DELETE",contentType:"application/json",statusCode:{200:function(){e&&window.location.reload()}}})};this.save=function(c,b){var e={};e[c.key]=c.val;b&&b.html('<img src="/structr/img/al.gif"> Saving');
$.ajax({url:a+c.id,method:"PUT",contentType:"application/json",data:JSON.stringify(e),statusCode:{200:function(){b&&b.text("Success!").remove()}}})};this.checkInput=function(a,f,e){a=a.which;isTextarea(e[0])?-1===e.val().indexOf("\n")&&(a=e.parent(),e.replaceWith(inputField(f.id,f.type,f.key,e.val())),e=b.input(a),e.on("keyup",function(a){b.checkInput(a,f,$(this))}),setCaretToEnd(e[0])):13===a&&(a=e.parent(),e.replaceWith(textarea(f.id,f.key,e.val()+"\n")),e=b.input(a),e.on("keyup",function(a){b.checkInput(a,
f,$(this))}),e.css({fontFamily:"sans-serif"}),setCaretToEnd(e[0]));resizeInput(e)};this.appendSaveButton=function(a,f,e,d,g){a.length&&$("#save_"+d+"_"+g).remove();e.after('<button class="save-button" id="save_'+d+"_"+g+'">Save</button>');$("#save_"+d+"_"+g).on("click",function(){var a=$(this),c=a.prev();b.save(b.field(c),a)})};this.hideEdit=function(a){$.each($("[data-structr-hide-id]",a),function(){var a=$(this).attr("data-structr-hide-id");$(this).replaceWith(f[a]);delete f[a]});$.each($('[data-structr-hide="edit"]',
a),function(a,b){var c=Math.floor(1E6*Math.random()+1);g[c]=$(b).clone(!0,!0);$(b).replaceWith('<div style="display:none;" data-structr-hide-id="'+c+'"></div>')});$(document).trigger("structr-edit")};this.hideNonEdit=function(a){void 0===a?$.each($('[data-structr-hide="non-edit"]'),function(a,b){var c=Math.floor(1E6*Math.random()+1);f[c]=$(b).clone(!0,!0);$(b).replaceWith('<div style="display:none;" data-structr-hide-id="'+c+'"></div>')}):($.each($("[data-structr-hide-id]",a),function(){var a=$(this).attr("data-structr-hide-id");
$(this).replaceWith(g[a]);delete f[a]}),$.each($('[data-structr-hide="non-edit"]',a),function(a,b){var c=Math.floor(1E6*Math.random()+1);f[c]=$(b).clone(!0,!0);$(b).replaceWith('<div style="display:none;" data-structr-hide-id="'+c+'"></div>')}))}}
function resizeInput(a){var b=a.val();if(b.length||!a.attr("size"))if(isTextarea(a[0])){var g=(b.match(/\n/g)||[]).length;a.attr("rows",g+2);b=b.split("\n").sort(function(a,b){return b.length-a.length})[0].length;a.attr("cols",b+1)}else a.attr("size",b.length+1)}function urlParam(a){a=a.replace(/[\[]/,"\\[").replace(/[\]]/,"\\]");return(a=RegExp("[\\?&]"+a+"=([^&#]*)").exec(window.location.href))&&a.length?a[1]:""}String.prototype.capitalize=function(){return this.charAt(0).toUpperCase()+this.slice(1)};
String.prototype.endsWith=function(a){return-1!==this.indexOf(a,this.length-a.length)};String.prototype.parseIfJSON=function(){if("{"===this.substring(0,1)){var a=this.replace(/'/g,'"');return JSON.parse(a)}return this};String.prototype.splitAndTitleize=function(a){var b=[];this.split(a).forEach(function(a){b.push(a.capitalize())});return b.join(" ")};String.prototype.toUnderscore=function(){return this.replace(/([A-Z])/g,function(a,b,g){return(0<g?"_":"")+a.toLowerCase()})};
"function"!==typeof String.prototype.contains&&(String.prototype.contains=function(a){return 0<this.indexOf(a)});function setCaretToEnd(a){var b=a.value.length;if(document.selection)a.focus(),a=document.selection.createRange(),a.moveStart("character",-b),a.moveStart("character",b),a.moveEnd("character",0),a.select();else if(a.selectionStart||0===a.selectionStart||"0"===a.selectionStart)a.selectionStart=b,a.selectionEnd=b,a.focus()}
function escapeTags(a){return a?a.replace(/&/g,"&amp;").replace(/</g,"&lt;").replace(/>/g,"&gt;"):a}function isTextarea(a){return"textarea"===a.nodeName.toLowerCase()}function textarea(a,b,g){return'<textarea class="structr-input-text">'+g+"</textarea>"}function inputField(a,b,g,f){a=f?f.length:b&&"Date"===b?25:g.length;return'<input class="structr-input-text" type="text" placeholder="'+(g?g.capitalize():"")+'" value="'+("null"===f?"":f)+'" size="'+a+'">'}
function field(a,b,g,f){return'<span type="text" data-structr-type="'+b+'" data-structr-attr="'+g+'">'+f+"</span>"}function checkbox(a,b,g,f){return'<input type="checkbox" data-structr-id="'+a+'" data-structr-type="'+b+'" '+(f?'checked="checked"':"")+'">'}function select(a,b,g,f){var c='<select data-structr-id="'+a+'">';$.each(f,function(a,b){c+="<option "+(b===g?"selected":"")+">"+b+"</option>"});return c+"</select>"}function enableButton(a){a.removeClass("disabled");a.removeAttr("disabled")}
function disableButton(a){a.addClass("disabled");a.attr("disabled","disabled")};